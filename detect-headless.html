<html>
  <head>
    <title>Detect Headless</title>
    <meta charset="utf-8">
    <style>
th{font-size:large}td:last-child{max-width:300px;word-wrap:break-word}td:first-child{text-align:center}.headful{background-color:#0f0}.headless{background-color:red}.undefined{background-color:#ff0}table,td,th{border:2px solid #000;border-collapse:collapse}td,th{padding:10px;text-align:center}.legend ul{margin:5px;margin-top:10px;padding:0;float:left;list-style:none}.legend ul li{list-style:none;margin-left:0;margin-bottom:5px}.legend ul li span{display:block;float:left;height:16px;width:16px;margin-right:5px;margin-left:0;border:1px solid #999}
    </style>
  </head>
  <body>
    <table>
      <tr>
        <th>Test</th>
        <th>Result</th>
      </tr>
    </table>
    <div class="legend">
      <ul>
        <li><span class="headful"></span>Headful</li>
        <li><span class="headless"></span>Headless</li>
        <li><span class="undefined"></span>Undefined</li>
      </ul>
    </div>
    <script>
      const HEADLESS=1,HEADFUL=0,UNDEFINED=-1;async function testBrowser(name,testFunction){const row=document.getElementById(name),resultBlock=document.getElementById(`-result`);result=await testFunction(resultBlock),1==result?row.classList.add("headless"):0==result?row.classList.add("headful"):row.classList.add("undefined")}function writeToBlock(block,text){block.innerHTML=text,generateComment(block.id,text)}function testUserAgent(resultBlock){let agent=navigator.userAgent;return writeToBlock(resultBlock,agent),/headless/i.test(agent)}function testAppVersion(resultBlock){let appVersion=navigator.appVersion;return writeToBlock(resultBlock,appVersion),/headless/i.test(appVersion)}function testPlugins(resultBlock){let length=navigator.plugins.length;return writeToBlock(resultBlock,`Detected  plugins`),0===length?-1:0}function testPluginsPrototype(resultBlock){let correctPrototypes=PluginArray.prototype===navigator.plugins.__proto__;return navigator.plugins.length>0&&(correctPrototypes&=Plugin.prototype===navigator.plugins[0].__proto__),writePluginsPrototypeResult(resultBlock,correctPrototypes),correctPrototypes?0:1}function writePluginsPrototypeResult(resultBlock,correctPrototypes){writeToBlock(resultBlock,correctPrototypes?"PluginArray and Plugin prototype are consistent":"PluginArray or Plugin prototype aren't consistent")}function testMime(resultBlock){let length=navigator.mimeTypes.length;return writeToBlock(resultBlock,`Detected  mime types`),0===length?-1:0}function testMimePrototype(resultBlock){let correctPrototypes=MimeTypeArray.prototype===navigator.mimeTypes.__proto__;return navigator.mimeTypes.length>0&&(correctPrototypes&=MimeType.prototype===navigator.mimeTypes[0].__proto__),writeMimePrototypeResult(resultBlock,correctPrototypes),correctPrototypes?0:1}function writeMimePrototypeResult(resultBlock,correctPrototypes){writeToBlock(resultBlock,correctPrototypes?"MimeTypeArray and MimeType prototype are consistent":"MimeTypeArray or MimeType prototype aren't consistent")}function testLanguages(resultBlock){let language=navigator.language,languagesLength=navigator.languages.length;return writeToBlock(resultBlock,`Detected  languages and using `),language&&0!==languagesLength?0:1}function testWebdriver(resultBlock){let webdriver=navigator.webdriver;return webdriverWriteResult(resultBlock,webdriver),webdriver?1:0}function webdriverWriteResult(resultBlock,webdriver){writeToBlock(resultBlock,webdriver?"Webdriver present":"Missing webdriver")}function testTimeElapse(resultBlock){let start=Date.now();alert("Press OK");let elapse=Date.now()-start;return timeElapseWriteResult(resultBlock,elapse),elapse<30}function timeElapseWriteResult(resultBlock,elapse){let signal;writeToBlock(resultBlock,`Time elapsed to close alert:  (${elapse<30?"<":">"} 30)`)}function testChrome(resultBlock){let chrome=window.chrome;return chromeWriteResult(resultBlock,chrome),chrome?0:-1}function chromeWriteResult(resultBlock,chrome){writeToBlock(resultBlock,chrome?"Chrome element present":"Chrome element not present")}async function testPermission(resultBlock){let permissionStatus,notificationPermission;return navigator.permissions?(permissionStatus=await navigator.permissions.query({name:"notifications"}),notificationPermission=Notification.permission,permissionWriteResult(resultBlock,permissionStatus,notificationPermission),"denied"===notificationPermission&&"prompt"===permissionStatus.state?1:0):(permissionWriteResult(resultBlock,permissionStatus,notificationPermission),-1)}function permissionWriteResult(resultBlock,permissionStatus,notificationPermission){writeToBlock(resultBlock,permissionStatus&&notificationPermission?`Permission stauts is "${permissionStatus.state}" and notification\n                              permission is ""`:"Object navigator.permissions is undefined")}function testDevtool(resultBlock){const any=/./;let count=0,oldToString=any.toString;any.toString=function(){return count++,"any"},console.debug(any);let usingDevTools=count>1;return devtoolWriteResult(resultBlock,usingDevTools),any.toString=oldToString,usingDevTools?-1:0}function devtoolWriteResult(resultBlock,usingDevTools){writeToBlock(resultBlock,usingDevTools?"Using devtools protocol":"Not using devtools protocol")}function testImage(resultBlock){var body=document.getElementById("image-result"),image=document.createElement("img");image.src="fake_image.png",body.appendChild(image),image.onerror=function(){return writeToBlock(resultBlock,`Broken image has width ${image.width} and height ${image.height}`),0===image.width&&0===image.height?1:0}}function testOuter(resultBlock){let outerHeight=window.outerHeight,outerWidth=window.outerWidth;return writeToBlock(resultBlock,`Outerheight:  and outerwidth: `),0===outerHeight&&0===outerWidth?1:0}function testConnectionRtt(resultBlock){let connection=navigator.connection,connectionRtt=connection?connection.rtt:void 0;return connectionRttWriteResult(resultBlock,connectionRtt),void 0===connectionRtt?-1:0===connectionRtt?1:0}function connectionRttWriteResult(resultBlock,connectionRtt){writeToBlock(resultBlock,void 0===connectionRtt?"Connection-rtt not defined":`Connection-rtt: `)}function testMouseMove(resultBlock){let zeroMovement=!0,mouseEventCounter=0;function mouseEvent(event){zeroMovement=zeroMovement&&0===event.movementX&&0===event.movementY,mouseEventCounter>50&&(document.getElementsByTagName("body")[0].removeEventListener("mousemove",mouseEvent),mouseMoveWriteResult(resultBlock,zeroMovement),resultBlock.parentElement.classList.remove("undefined"),zeroMovement?resultBlock.parentElement.classList.add("headless"):resultBlock.parentElement.classList.add("headful")),mouseEventCounter++}document.getElementsByTagName("body")[0].addEventListener("mousemove",mouseEvent),writeToBlock(resultBlock,"Move your mouse")}function mouseMoveWriteResult(resultBlock,zeroMovement){writeToBlock(resultBlock,zeroMovement?"MovementX and movementY are 0 in every mouse event":"MovementX and movementY vary in mouse events")}const tests=[{name:"User Agent",id:"user-agent",testFunction:testUserAgent},{name:"App Version",id:"app-version",testFunction:testAppVersion},{name:"Plugins",id:"plugins",testFunction:testPlugins},{name:"Plugins Prototype",id:"plugins-prototype",testFunction:testPluginsPrototype},{name:"Mime",id:"mime",testFunction:testMime},{name:"Mime Prototype",id:"mime-prototype",testFunction:testMimePrototype},{name:"Languages",id:"languages",testFunction:testLanguages},{name:"Webdriver",id:"webdriver",testFunction:testWebdriver},{name:"Time Elapse",id:"time-elapse",testFunction:testTimeElapse},{name:"Chrome",id:"chrome-element",testFunction:testChrome},{name:"Permission",id:"permission",testFunction:testPermission},{name:"Devtool Protocol",id:"devtool",testFunction:testDevtool},{name:"Broken Image",id:"image",testFunction:testImage},{name:"Outer dimensions",id:"outer",testFunction:testOuter},{name:"Connection Rtt",id:"connection-rtt",testFunction:testConnectionRtt},{name:"Mouse Move",id:"mouse-move",testFunction:testMouseMove}];function generateComment(test,result){if(/.*-result/.test(test)){let comment=document.createComment(`: `);document.body.appendChild(comment)}}function generateTableRow(name,id){let table,row=document.getElementsByTagName("table")[0].insertRow();row.id=id;let nameBlock=row.insertCell(),resultBlock=row.insertCell();writeToBlock(nameBlock,name),resultBlock.id=`-result`}tests.forEach(test=>{generateTableRow(test.name,test.id),testBrowser(test.id,test.testFunction,test.resultFunction)});
    </script>
  </body>
</html>
